name: Nginx CI/CD (Desarrollo)

on:
  # ğŸ¯ Cambiar el trigger a la rama de desarrollo
  push:
    branches: [ develop ] 
  pull_request:
    branches: [ develop ]

jobs:
  build-and-deploy:
    # Usar una mÃ¡quina mÃ¡s potente si la construcciÃ³n es lenta
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    # Omitir el Login a Docker Hub si solo se despliega localmente en el servidor de desarrollo.
    # Si quieres persistir la imagen en Docker Hub:
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
        
    - name: Build and push Docker image (Desarrollo)
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        # ğŸ·ï¸ Usar una etiqueta de desarrollo
        tags: ${{ secrets.DOCKER_USERNAME }}/nginx-app:dev
        
    - name: Deploy to development server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEV_SERVER_HOST }} # ğŸ”‘ Usar un secreto para el servidor de desarrollo
        username: ${{ secrets.DEV_SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # â¬‡ï¸ Pull de la imagen de desarrollo
          docker pull ${{ secrets.DOCKER_USERNAME }}/nginx-app:dev
          # ğŸ›‘ Parar y eliminar el contenedor de desarrollo existente
          docker stop nginx-dev-container || true
          docker rm nginx-dev-container || true
          # ğŸš€ Ejecutar el nuevo contenedor de desarrollo
          # Podemos exponer un puerto diferente, por ejemplo, 8080, para evitar conflictos
          docker run -d --name nginx-dev-container -p 8080:80 ${{ secrets.DOCKER_USERNAME }}/nginx-app:dev
